/**
 * ys-reppam - Reppam a mapping function used in conjuction with google maps API
 * @version v0.2.0
 * @link http://youngskilled.com
 * @author richard@youngskilled.com Young/Skilled
 * @license MIT
 */
!function(e,t){t.reppamCallback=function(){e(t).trigger("scriptLoaded.reppam")};var o={init:function(){var a=this,n=a.set.urlParams,s=a.set.mapsURL+"?callback=window.reppamCallback";if("undefined"==typeof google){for(var i in n)s+="&"+i+"="+n[i];e.ajax({url:s,dataType:"script",error:function(e){a.set.debug&&console.log("Google maps has failed to load, message: "+e)}})}else e(t).trigger("scriptLoaded.reppam");e(t).on("scriptLoaded.reppam",function(){o.getData.apply(a)})},getData:function(){var t=this;e.ajax({url:t.set.mapData,type:"GET",dataType:"JSON",success:function(e){t.set.mapData=e,t.data("mapData",e),o.renderMap.apply(t)},error:function(e){t.set.debug&&console.log("Markers data has failed to load, message: ",e)}})},renderMap:function(){var e,t,a,n,s=this;s.set.mapData.countries?(e=s.set.mapData.countries[s.set.mapData.currentLocation[0]],s.set.defaultCountry!==!1&&(o.withinBounds(e.sw,e.ne,s.set.mapData.locations)||(e=s.set.mapData.countries[s.set.defaultCountry])),t=new google.maps.LatLng(e.sw.lat,e.sw.lng),a=new google.maps.LatLng(e.ne.lat,e.ne.lng),n=new google.maps.LatLngBounds(t,a)):(s.set.mapOptions.center=new google.maps.LatLng(0,0),s.set.mapOptions.zoom=2),s.set.map=new google.maps.Map(s[0],s.set.mapOptions),s.set.mapData.countries&&s.set.map.fitBounds(n),s.data("map",s.set.map),o.logPosition.apply(s),o.enableEvents.apply(s),o.addMarkers.apply(s)},enableEvents:function(){var a=this;e("#locate-me").on("click",function(t){t.preventDefault();var n=e(this);n.addClass("loading"),o.getLocation(function(e){o.addMe.apply(a,[e]),n.removeClass("loading").addClass("loaded")})}),e("#nearest").on("click",function(t){t.preventDefault();var n,s,i,r=e(this),l=[];r.addClass("loading"),o.getLocation(function(e){var t;o.addMe.apply(a,[e]),a.set.current.crowFlies&&a.set.current.crowFlies.setMap(null),r.removeClass("loading").addClass("loaded"),l=o.findNearest(e,a.set.mapData.locations),n=new google.maps.LatLng(e.lat,e.lng),s=new google.maps.LatLng(l[0].data.latitude,l[0].data.longitude),t=new google.maps.Polyline({path:[n,s],geodesic:!0,strokeColor:a.set.strokeColor,strokeWeight:3}),google.maps.event.addListener(t,"click",function(){i=new google.maps.LatLngBounds,i.extend(n),i.extend(s),a.set.map.fitBounds(i),o.logPosition.apply(a)}),t.setMap(a.set.map),l[0].distance<100?(i=new google.maps.LatLngBounds,i.extend(n),i.extend(s),a.set.map.fitBounds(i)):(a.set.map.setCenter(s),a.set.map.setZoom(a.set.zoomedIn)),a.set.current.crowFlies=t,o.logPosition.apply(a)})}),e(t).on("resize",function(){a.set.map.setCenter(a.set.center),a.set.map.setZoom(a.set.zoom)})},addMe:function(e){var t,a,n=this,s=n.set.personMarker,i={};n.set.current.position&&n.set.current.position.setMap(null),a=new google.maps.LatLng(e.lat,e.lng),i.position=a,s!==!1&&(i.icon={},s.url&&(i.icon.url=s.url),s.anchor&&(i.icon.anchor=new google.maps.Point(s.anchor[0],s.anchor[1])),s.origin&&(i.icon.origin=new google.maps.Point(s.origin[0],s.origin[1])),s.size&&(i.icon.size=new google.maps.Size(s.size[0],s.size[1])),s.scaledSize&&(i.icon.scaledSize=new google.maps.Size(s.scaledSize[0],s.scaledSize[1]))),t=new google.maps.Marker(i),t.setMap(n.set.map),n.set.map.setCenter(a),google.maps.event.addListener(t,"click",function(){n.set.map.getZoom()<n.set.zoomedIn&&n.set.map.setZoom(n.set.zoomedIn),n.set.map.panTo(this.getPosition()),o.logPosition.apply(n)}),n.set.current.position=t},addMarkers:function(){var e,t,a,n,s=this,i=s.set.mapData.locations,r=s.set.singleMarker,l=s.set.multipleMarker,c=[],d={},p={};for(var g in i)t=i[g],""!==t.latitude&&""!==t.longitude&&(e=new google.maps.LatLng(t.latitude,t.longitude),d={id:g,content:i[g].address,position:e,title:i[g].name},r!==!1&&(d.icon={},r.url&&(d.icon.url=r.url),r.anchor&&(d.icon.anchor=new google.maps.Point(r.anchor[0],r.anchor[1])),r.origin&&(d.icon.origin=new google.maps.Point(r.origin[0],r.origin[1])),r.size&&(d.icon.size=new google.maps.Size(r.size[0],r.size[1])),r.scaledSize&&(d.icon.scaledSize=new google.maps.Size(r.scaledSize[0],r.scaledSize[1]))),a=new google.maps.Marker(d),google.maps.event.addListener(a,"click",function(){var e=new google.maps.InfoWindow({content:this.content});s.set.current.infoWindow&&s.set.current.infoWindow.close(),s.set.map.getZoom()<s.set.zoomedIn&&this.id===s.set.current.viewed&&s.set.map.setZoom(s.set.zoomedIn),s.set.map.panTo(this.getPosition()),e.open(s.set.map,this),s.set.current.infoWindow=e,s.set.current.viewed=this.id,o.logPosition.apply(s)}),c.push(a));if("undefined"!=typeof MarkerClusterer)n=new MarkerClusterer(s.set.map,c,{maxZoom:s.set.zoomedIn-1}),l!==!1&&(p={},l.url&&(p.url=l.url),l.anchor&&(p.anchorIcon=[l.anchor[1],l.anchor[0]]),l.origin&&(p.backgroundPosition="-"+l.origin[0]+"px -"+l.origin[1]+"px"),l.size&&(p.width=l.size[0]),l.size&&(p.height=l.size[1]),l.anchorText&&(p.anchorText=l.anchorText),l.fontFamily&&(p.fontFamily=l.fontFamily),l.fontStyle&&(p.fontStyle=l.fontStyle),l.fontWeight&&(p.fontWeight=l.fontWeight),l.textColor&&(p.textColor=l.textColor),l.textDecoration&&(p.textDecoration=l.textDecoration),l.textSize&&(p.textSize=l.textSize),n.setStyles([p]));else for(var u=0;u<c.length;u++)c[u].setMap(s.set.map)},logPosition:function(){var e=this;e.set.center=e.set.map.getCenter(),e.set.zoom=e.set.map.getZoom()},moveToMarker:function(e,t){var o,a=this,n=a.set.mapData.locations[e];return t=t||function(){},""===n.latitude||""===n.longitude?(a.set.debug&&console.log("This location has no coordinates."),t({success:!1})):(o=new google.maps.LatLng(n.latitude,n.longitude),a.set.map.setCenter(o),a.set.map.setZoom(a.set.zoomedIn),t({success:!0}))},moveToCoords:function(e){var t,o=this;return e.callback=e.callback||function(){},e.lat&&e.lng&&e.zoom?(t=new google.maps.LatLng(e.lat,e.lng),o.set.map.setCenter(t),o.set.map.setZoom(e.zoom),e.callback({success:!0})):(o.set.debug&&console.log("Coordinates need all the values. Latitude, longitude and zoom lat:"+e.lat+" lng: "+e.lng+" zoom: "+e.zoom),e.callback({success:!1}))},getLocation:function(e){var t;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){return t={lat:o.coords.latitude,lng:o.coords.longitude},"function"==typeof e?e(t):void 0},function(){handleNoGeolocation(!0)}):handleNoGeolocation(!1)},withinBounds:function(e,t,o){var a,n,s,i=!1;for(a in o)if(n=!1,s=o[a],s.latitude>e.lat&&s.latitude<t.lat&&(n=!0),n&&s.longitude>e.lng&&s.longitude<t.lng){i=!0;break}return i},findNearest:function(e,t){var a,n,s=[],i=0;for(a in t)n={lat:t[a].latitude,lng:t[a].longitude},s[i]={id:a,distance:o.haversine(e,n),data:t[a]},i++;return s.sort(function(e,t){return e.distance-t.distance}),s},radians:function(e){return e*Math.PI/180},haversine:function(e,t){var a=6371,n=o.radians(t.lat-e.lat),s=o.radians(t.lng-e.lng),i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(o.radians(e.lat))*Math.cos(o.radians(t.lat))*Math.sin(s/2)*Math.sin(s/2),r=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),l=a*r;return Math.round(l)}},a={init:function(t){return this.each(function(){var a=e(this),i=a.data();a.set=e.extend({},n,t,i,s),o.init.apply(a),a.data(a.set)})},showOnMap:function(t){return this.each(function(){{var a=e(this);a.data()}a.set=e.extend({},a.data()),o.moveToMarker.apply(a,[t.id,t.callback]),a.data(a.set)})},showCoords:function(t){return this.each(function(){{var a=e(this);a.data()}a.set=e.extend({},a.data()),o.moveToCoords.apply(a,[t]),a.data(a.set)})},update:function(t){return this.each(function(){var a=e(this);a.set=e.extend({},a.data(),t),o.update.apply(a),a.data(a.set)})},destroy:function(t){return this.each(function(){var o=e(this);o.set=e.extend({},o.data(),t,s)})}},n={debug:!1,mapsURL:"//maps.google.com/maps/api/js",urlParams:{},defaultCountry:!1,mapData:"map-data.json",mapOptions:{},multipleMarker:!1,singleMarker:!1,personMarker:!1,zoomedIn:14,strokeColor:"#000000"},s={center:void 0,current:{infoWindow:void 0,position:void 0,nearestStore:void 0,crowFlies:void 0}};e.fn.reppam=function(t){return a[t]?a[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.reppam"):a.init.apply(this,arguments)}}(jQuery,window);