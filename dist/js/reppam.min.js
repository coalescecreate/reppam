/**
 * ys-reppam - Reppam a mapping function used in conjuction with google maps API
 * @version v0.8.0
 * @link http://youngskilled.com
 * @author richard@youngskilled.com Young/Skilled
 * @license MIT
 */
!function(e,t){t.reppamCallback=function(){e(t).trigger("scriptLoaded.reppam")};var a={init:function(){var o=this,n=o.set.urlParams,s=o.set.mapsURL+"?callback=window.reppamCallback";if("undefined"==typeof google){for(var i in n)s+="&"+i+"="+n[i];e.ajax({url:s,dataType:"script",error:function(e){o.set.debug&&console.log("Google maps has failed to load, message: "+e)}})}else a.getData.apply(o);e(t).on("scriptLoaded.reppam",function(){a.getData.apply(o)})},getData:function(){var t=this;"object"==typeof t.set.mapData?(a.renderMap.apply(t),t.data(t.set)):e.ajax({url:t.set.mapData,type:"GET",dataType:"JSON",success:function(e){t.set.mapData=e,a.renderMap.apply(t),t.data(t.set)},error:function(e){t.set.debug&&console.log("Map data has failed to load, message: ",e)}})},renderMap:function(){var e,t,o,n,s=this;s.set.startPosition!==!1?(s.set.mapOptions.center=a.parseLatLng.apply(s,[s.set.startPosition.lat,s.set.startPosition.lng,s.set.startPosition]),s.set.mapOptions.zoom=parseInt(s.set.startPosition.zoom)):s.set.mapData.countries?(e=s.set.mapData.countries[s.set.mapData.currentLocation[0]],s.set.defaultCountry!==!1&&(a.withinBounds(e.sw,e.ne,s.set.mapData.locations)||(e=s.set.mapData.countries[s.set.defaultCountry])),t=new google.maps.LatLng(e.sw.lat,e.sw.lng),o=new google.maps.LatLng(e.ne.lat,e.ne.lng),n=new google.maps.LatLngBounds(t,o)):(s.set.mapOptions.center=new google.maps.LatLng(0,0),s.set.mapOptions.zoom=2),s.set.map=new google.maps.Map(s[0],s.set.mapOptions),s.set.mapData.countries&&s.set.startPosition===!1&&s.set.map.fitBounds(n),s.data("map",s.set.map),google.maps.event.addListener(s.set.map,"tilesloaded",function(){a.logPosition.apply(s)}),a.enableEvents.apply(s),a.addMarkers.apply(s),s.trigger("reppam.isLoaded",[s.set.mapData])},enableEvents:function(){var o=this;e("#locate-me").on("click",function(t){t.preventDefault();var n=e(this);n.addClass("loading"),a.getLocation(function(e){a.addMe.apply(o,[e]),n.removeClass("loading").addClass("loaded")})}),e("#nearest").on("click",function(t){t.preventDefault();var n,s,i,r=e(this),l=[];r.addClass("loading"),a.getLocation(function(e){var t;a.addMe.apply(o,[e]),o.set.current.crowFlies&&o.set.current.crowFlies.setMap(null),r.removeClass("loading").addClass("loaded"),l=a.findNearest(e,o.set.mapData.locations),n=new google.maps.LatLng(e.lat,e.lng),s=new google.maps.LatLng(l[0].data.latitude,l[0].data.longitude),t=new google.maps.Polyline({path:[n,s],geodesic:!0,strokeColor:o.set.strokeColor,strokeWeight:3}),google.maps.event.addListener(t,"click",function(){i=new google.maps.LatLngBounds,i.extend(n),i.extend(s),o.set.map.fitBounds(i),a.logPosition.apply(o)}),t.setMap(o.set.map),l[0].distance<100?(i=new google.maps.LatLngBounds,i.extend(n),i.extend(s),o.set.map.fitBounds(i)):(o.set.map.setCenter(s),o.set.map.setZoom(o.set.zoomedIn)),o.set.current.crowFlies=t,a.logPosition.apply(o)})}),e(t).on("resize",function(){a.logPosition.apply(o),o.set.current.infoWindow&&(o.set.map.setCenter(o.set.current.infoWindow.position),o.set.map.setZoom(o.set.zoom)),google.maps.event.trigger(o.set.map,"resize")})},addMe:function(e){var t,o,n=this,s=n.set.personMarker,i={};n.set.current.position&&n.set.current.position.setMap(null),o=new google.maps.LatLng(e.lat,e.lng),i.position=o,s!==!1&&(i.icon={},s.url&&(i.icon.url=s.url),s.anchor&&(i.icon.anchor=new google.maps.Point(s.anchor[0],s.anchor[1])),s.origin&&(i.icon.origin=new google.maps.Point(s.origin[0],s.origin[1])),s.size&&(i.icon.size=new google.maps.Size(s.size[0],s.size[1])),s.scaledSize&&(i.icon.scaledSize=new google.maps.Size(s.scaledSize[0],s.scaledSize[1]))),t=new google.maps.Marker(i),t.setMap(n.set.map),n.set.map.setCenter(o),n.set.map.getZoom()<13&&n.set.map.setZoom(13),google.maps.event.addListener(t,"click",function(){n.set.map.getZoom()<n.set.zoomedIn&&n.set.map.setZoom(n.set.zoomedIn),n.set.map.panTo(this.getPosition()),a.logPosition.apply(n)}),n.set.current.position=t},addMarkers:function(){var e,t,o,n=this,s=n.set.mapData.locations,i=n.set.singleMarker,r=n.set.multipleMarker,l={},c={},p="";for(var d in s)t=s[d],e=a.parseLatLng.apply(n,[t.latitude,t.longitude,d]),e&&(p=s[d].address,n.set.useTitleInInfoWindow&&(p="<strong>"+s[d].name+"</strong><br>"+p),l={id:d,content:p,position:e,title:s[d].name},i!==!1&&(l.icon={},i.url&&(l.icon.url=i.url),i.anchor&&(l.icon.anchor=new google.maps.Point(i.anchor[0],i.anchor[1])),i.origin&&(l.icon.origin=new google.maps.Point(i.origin[0],i.origin[1])),i.size&&(l.icon.size=new google.maps.Size(i.size[0],i.size[1])),i.scaledSize&&(l.icon.scaledSize=new google.maps.Size(i.scaledSize[0],i.scaledSize[1]))),o=new google.maps.Marker(l),google.maps.event.addListener(o,"click",function(){var e=new google.maps.InfoWindow({content:this.content});n.set.current.infoWindow&&n.set.current.infoWindow.close(),n.set.map.getZoom()<n.set.zoomedIn&&this.id===n.set.current.viewed&&n.set.map.setZoom(n.set.zoomedIn),n.set.map.panTo(this.getPosition()),e.open(n.set.map,this),n.set.current.infoWindow=e,n.set.current.viewed=this.id,a.logPosition.apply(n)}),n.set.markers.push(o));if("undefined"!=typeof MarkerClusterer&&n.set.useMarkerClusterer)n.set.markerCluster=new MarkerClusterer(n.set.map,n.set.markers,{maxZoom:n.set.zoomedIn-1}),r!==!1&&(c={},r.url&&(c.url=r.url),r.anchor&&(c.anchorIcon=[r.anchor[1],r.anchor[0]]),r.origin&&(c.backgroundPosition="-"+r.origin[0]+"px -"+r.origin[1]+"px"),r.size&&(c.width=r.size[0]),r.size&&(c.height=r.size[1]),r.anchorText&&(c.anchorText=r.anchorText),r.fontFamily&&(c.fontFamily=r.fontFamily),r.fontStyle&&(c.fontStyle=r.fontStyle),r.fontWeight&&(c.fontWeight=r.fontWeight),r.textColor&&(c.textColor=r.textColor),r.textDecoration&&(c.textDecoration=r.textDecoration),r.textSize&&(c.textSize=r.textSize),n.set.markerCluster.setStyles([c]));else for(var g=0;g<n.set.markers.length;g++)n.set.markers[g].setMap(n.set.map)},removeAllMarkers:function(){for(var e=this,t=0;t<e.set.markers.length;t++)e.set.markers[t].setMap(null);e.set.markers=[],"undefined"!=typeof MarkerClusterer&&e.set.useMarkerClusterer&&e.set.markerCluster.clearMarkers()},logPosition:function(){var e=this;e.set.center=e.set.map.getCenter(),e.set.zoom=e.set.map.getZoom()},moveToMarker:function(e,t){var a,o,n=this,s=n.set.mapData.locations[e];if(t=t||function(){},""===s.latitude||""===s.longitude)return n.set.debug&&console.log("This location has no coordinates."),t({success:!1});a=new google.maps.LatLng(s.latitude,s.longitude);for(var i=0;i<n.set.markers.length;i++)n.set.markers[i].id==e&&(o=i);return void 0!==o&&google.maps.event.trigger(n.set.markers[o],"click"),n.set.map.setCenter(a),n.set.map.setZoom(n.set.zoomedIn),t({success:!0})},moveToCoords:function(e){var t,a=this;return e.callback=e.callback||function(){},e.lat&&e.lng&&e.zoom?(t=new google.maps.LatLng(e.lat,e.lng),a.set.map.setCenter(t),a.set.map.setZoom(e.zoom),e.callback({success:!0})):(a.set.debug&&console.log("Coordinates need all the values. Latitude, longitude and zoom lat:"+e.lat+" lng: "+e.lng+" zoom: "+e.zoom),e.callback({success:!1}))},moveToBounds:function(e){var t,a=this;return e.callback=e.callback||function(){},e.sw&&e.ne?(swObj=new google.maps.LatLng(e.sw.lat,e.sw.lng),neObj=new google.maps.LatLng(e.ne.lat,e.ne.lng),t=new google.maps.LatLngBounds(swObj,neObj),a.set.map.fitBounds(t),e.callback({success:!0})):(a.set.debug&&console.log("Bounds need the latitude and longitude of the north-eastern and south-western corners, ne:"+JSON.stringify(e.ne)+" sw: "+JSON.stringify(e.sw)),e.callback({success:!1}))},getLocation:function(e){var t;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){return t={lat:a.coords.latitude,lng:a.coords.longitude},"function"==typeof e?e(t):void 0},function(){handleNoGeolocation(!0)}):handleNoGeolocation(!1)},withinBounds:function(e,t,a){var o,n,s,i=!1;for(o in a)if(n=!1,s=a[o],s.latitude>e.lat&&s.latitude<t.lat&&(n=!0),n&&s.longitude>e.lng&&s.longitude<t.lng){i=!0;break}return i},findNearest:function(e,t){var o,n,s=[],i=0;for(o in t)n={lat:t[o].latitude,lng:t[o].longitude},s[i]={id:o,distance:a.haversine(e,n),data:t[o]},i++;return s.sort(function(e,t){return e.distance-t.distance}),s},radians:function(e){return e*Math.PI/180},haversine:function(e,t){var o=6371,n=a.radians(t.lat-e.lat),s=a.radians(t.lng-e.lng),i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a.radians(e.lat))*Math.cos(a.radians(t.lat))*Math.sin(s/2)*Math.sin(s/2),r=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),l=o*r;return Math.round(l)},parseLatLng:function(e,t,a){var o=this,n=parseFloat(e),s=parseFloat(t);return isNaN(n)||isNaN(s)?(o.set.debug&&console.log("There was a problem with marker â†’",a,e,t),!1):new google.maps.LatLng(n,s)}},o={init:function(t){return this.each(function(){var o=e(this),i=o.data();o.set=e.extend({},n,t,i,s),a.init.apply(o)})},showOnMap:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data()),a.moveToMarker.apply(o,[t.id,t.callback]),o.data(o.set)})},showCoords:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data()),a.moveToCoords.apply(o,[t]),o.data(o.set)})},showBounds:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data()),a.moveToBounds.apply(o,[t]),o.data(o.set)})},removeAllMarkers:function(){return this.each(function(){{var t=e(this);t.data()}t.set=e.extend({},t.data()),a.removeAllMarkers.apply(t),t.data(t.set)})},replaceAllMarkers:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data(),t),a.removeAllMarkers.apply(o),a.addMarkers.apply(o),t.startPosition&&a.moveToCoords.apply(o,[t.startPosition]),o.data(o.set)})},update:function(t){return this.each(function(){var o=e(this);o.set=e.extend({},o.data(),t),a.update.apply(o),o.data(o.set)})},destroy:function(t){return this.each(function(){var a=e(this);a.set=e.extend({},a.data(),t,s)})}},n={debug:!1,mapsURL:"//maps.google.com/maps/api/js",urlParams:{},defaultCountry:!1,mapData:"map-data.json",mapOptions:{},markers:[],markerCluster:{},multipleMarker:!1,singleMarker:!1,personMarker:!1,zoomedIn:14,startPosition:!1,strokeColor:"#000000",useMarkerClusterer:!0,useTitleInInfoWindow:!1},s={center:void 0,current:{infoWindow:void 0,position:void 0,nearestStore:void 0,crowFlies:void 0}};e.fn.reppam=function(t){return o[t]?o[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.reppam"):o.init.apply(this,arguments)}}(jQuery,window);