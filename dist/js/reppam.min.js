/**
 * ys-reppam - Reppam a mapping function used in conjuction with google maps API
 * @version v0.5.1
 * @link http://youngskilled.com
 * @author richard@youngskilled.com Young/Skilled
 * @license MIT
 */
!function(e,t){t.reppamCallback=function(){e(t).trigger("scriptLoaded.reppam")};var a={init:function(){var o=this,n=o.set.urlParams,s=o.set.mapsURL+"?callback=window.reppamCallback";if("undefined"==typeof google){for(var r in n)s+="&"+r+"="+n[r];e.ajax({url:s,dataType:"script",error:function(e){o.set.debug&&console.log("Google maps has failed to load, message: "+e)}})}else a.getData.apply(o);e(t).on("scriptLoaded.reppam",function(){a.getData.apply(o)})},getData:function(){var t=this;"object"==typeof t.set.mapData?(a.renderMap.apply(t),t.data(t.set)):e.ajax({url:t.set.mapData,type:"GET",dataType:"JSON",success:function(e){t.set.mapData=e,a.renderMap.apply(t),t.data(t.set)},error:function(e){t.set.debug&&console.log("Map data has failed to load, message: ",e)}})},renderMap:function(){var e,t,o,n,s=this;s.set.startPosition!==!1?(s.set.mapOptions.center=a.parseLatLng.apply(s,[s.set.startPosition.lat,s.set.startPosition.lng,s.set.startPosition]),s.set.mapOptions.zoom=parseInt(s.set.startPosition.zoom)):s.set.mapData.countries?(e=s.set.mapData.countries[s.set.mapData.currentLocation[0]],s.set.defaultCountry!==!1&&(a.withinBounds(e.sw,e.ne,s.set.mapData.locations)||(e=s.set.mapData.countries[s.set.defaultCountry])),t=new google.maps.LatLng(e.sw.lat,e.sw.lng),o=new google.maps.LatLng(e.ne.lat,e.ne.lng),n=new google.maps.LatLngBounds(t,o)):(s.set.mapOptions.center=new google.maps.LatLng(0,0),s.set.mapOptions.zoom=2),s.set.map=new google.maps.Map(s[0],s.set.mapOptions),s.set.mapData.countries&&s.set.startPosition===!1&&s.set.map.fitBounds(n),s.data("map",s.set.map),google.maps.event.addListener(s.set.map,"tilesloaded",function(){a.logPosition.apply(s)}),a.enableEvents.apply(s),a.addMarkers.apply(s)},enableEvents:function(){var o=this;e("#locate-me").on("click",function(t){t.preventDefault();var n=e(this);n.addClass("loading"),a.getLocation(function(e){a.addMe.apply(o,[e]),n.removeClass("loading").addClass("loaded")})}),e("#nearest").on("click",function(t){t.preventDefault();var n,s,r,i=e(this),l=[];i.addClass("loading"),a.getLocation(function(e){var t;a.addMe.apply(o,[e]),o.set.current.crowFlies&&o.set.current.crowFlies.setMap(null),i.removeClass("loading").addClass("loaded"),l=a.findNearest(e,o.set.mapData.locations),n=new google.maps.LatLng(e.lat,e.lng),s=new google.maps.LatLng(l[0].data.latitude,l[0].data.longitude),t=new google.maps.Polyline({path:[n,s],geodesic:!0,strokeColor:o.set.strokeColor,strokeWeight:3}),google.maps.event.addListener(t,"click",function(){r=new google.maps.LatLngBounds,r.extend(n),r.extend(s),o.set.map.fitBounds(r),a.logPosition.apply(o)}),t.setMap(o.set.map),l[0].distance<100?(r=new google.maps.LatLngBounds,r.extend(n),r.extend(s),o.set.map.fitBounds(r)):(o.set.map.setCenter(s),o.set.map.setZoom(o.set.zoomedIn)),o.set.current.crowFlies=t,a.logPosition.apply(o)})}),e(t).on("resize",function(){a.logPosition.apply(o),o.set.current.infoWindow&&(o.set.map.setCenter(o.set.current.infoWindow.position),o.set.map.setZoom(o.set.zoom)),google.maps.event.trigger(o.set.map,"resize")})},addMe:function(e){var t,o,n=this,s=n.set.personMarker,r={};n.set.current.position&&n.set.current.position.setMap(null),o=new google.maps.LatLng(e.lat,e.lng),r.position=o,s!==!1&&(r.icon={},s.url&&(r.icon.url=s.url),s.anchor&&(r.icon.anchor=new google.maps.Point(s.anchor[0],s.anchor[1])),s.origin&&(r.icon.origin=new google.maps.Point(s.origin[0],s.origin[1])),s.size&&(r.icon.size=new google.maps.Size(s.size[0],s.size[1])),s.scaledSize&&(r.icon.scaledSize=new google.maps.Size(s.scaledSize[0],s.scaledSize[1]))),t=new google.maps.Marker(r),t.setMap(n.set.map),n.set.map.setCenter(o),n.set.map.getZoom()<13&&n.set.map.setZoom(13),google.maps.event.addListener(t,"click",function(){n.set.map.getZoom()<n.set.zoomedIn&&n.set.map.setZoom(n.set.zoomedIn),n.set.map.panTo(this.getPosition()),a.logPosition.apply(n)}),n.set.current.position=t},addMarkers:function(){var e,t,o,n=this,s=n.set.mapData.locations,r=n.set.singleMarker,i=n.set.multipleMarker,l={},p={};for(var c in s)t=s[c],e=a.parseLatLng.apply(n,[t.latitude,t.longitude,c]),e&&(l={id:c,content:s[c].address,position:e,title:s[c].name},r!==!1&&(l.icon={},r.url&&(l.icon.url=r.url),r.anchor&&(l.icon.anchor=new google.maps.Point(r.anchor[0],r.anchor[1])),r.origin&&(l.icon.origin=new google.maps.Point(r.origin[0],r.origin[1])),r.size&&(l.icon.size=new google.maps.Size(r.size[0],r.size[1])),r.scaledSize&&(l.icon.scaledSize=new google.maps.Size(r.scaledSize[0],r.scaledSize[1]))),o=new google.maps.Marker(l),google.maps.event.addListener(o,"click",function(){var e=new google.maps.InfoWindow({content:this.content});n.set.current.infoWindow&&n.set.current.infoWindow.close(),n.set.map.getZoom()<n.set.zoomedIn&&this.id===n.set.current.viewed&&n.set.map.setZoom(n.set.zoomedIn),n.set.map.panTo(this.getPosition()),e.open(n.set.map,this),n.set.current.infoWindow=e,n.set.current.viewed=this.id,a.logPosition.apply(n)}),n.set.markers.push(o));if("undefined"!=typeof MarkerClusterer&&n.set.useMarkerClusterer)n.set.markerCluster=new MarkerClusterer(n.set.map,n.set.markers,{maxZoom:n.set.zoomedIn-1}),i!==!1&&(p={},i.url&&(p.url=i.url),i.anchor&&(p.anchorIcon=[i.anchor[1],i.anchor[0]]),i.origin&&(p.backgroundPosition="-"+i.origin[0]+"px -"+i.origin[1]+"px"),i.size&&(p.width=i.size[0]),i.size&&(p.height=i.size[1]),i.anchorText&&(p.anchorText=i.anchorText),i.fontFamily&&(p.fontFamily=i.fontFamily),i.fontStyle&&(p.fontStyle=i.fontStyle),i.fontWeight&&(p.fontWeight=i.fontWeight),i.textColor&&(p.textColor=i.textColor),i.textDecoration&&(p.textDecoration=i.textDecoration),i.textSize&&(p.textSize=i.textSize),n.set.markerCluster.setStyles([p]));else for(var d=0;d<n.set.markers.length;d++)n.set.markers[d].setMap(n.set.map)},removeAllMarkers:function(){for(var e=this,t=0;t<e.set.markers.length;t++)e.set.markers[t].setMap(null);e.set.markers=[],"undefined"!=typeof MarkerClusterer&&e.set.useMarkerClusterer&&e.set.markerCluster.clearMarkers()},logPosition:function(){var e=this;e.set.center=e.set.map.getCenter(),e.set.zoom=e.set.map.getZoom()},moveToMarker:function(e,t){var a,o,n=this,s=n.set.mapData.locations[e];if(t=t||function(){},""===s.latitude||""===s.longitude)return n.set.debug&&console.log("This location has no coordinates."),t({success:!1});a=new google.maps.LatLng(s.latitude,s.longitude);for(var r=0;r<n.set.markers.length;r++)n.set.markers[r].id==e&&(o=r);return console.log("var whichMarker",o),void 0!==o&&google.maps.event.trigger(n.set.markers[o],"click"),n.set.map.setCenter(a),n.set.map.setZoom(n.set.zoomedIn),t({success:!0})},moveToCoords:function(e){var t,a=this;return e.callback=e.callback||function(){},e.lat&&e.lng&&e.zoom?(t=new google.maps.LatLng(e.lat,e.lng),a.set.map.setCenter(t),a.set.map.setZoom(e.zoom),e.callback({success:!0})):(a.set.debug&&console.log("Coordinates need all the values. Latitude, longitude and zoom lat:"+e.lat+" lng: "+e.lng+" zoom: "+e.zoom),e.callback({success:!1}))},getLocation:function(e){var t;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(a){return t={lat:a.coords.latitude,lng:a.coords.longitude},"function"==typeof e?e(t):void 0},function(){handleNoGeolocation(!0)}):handleNoGeolocation(!1)},withinBounds:function(e,t,a){var o,n,s,r=!1;for(o in a)if(n=!1,s=a[o],s.latitude>e.lat&&s.latitude<t.lat&&(n=!0),n&&s.longitude>e.lng&&s.longitude<t.lng){r=!0;break}return r},findNearest:function(e,t){var o,n,s=[],r=0;for(o in t)n={lat:t[o].latitude,lng:t[o].longitude},s[r]={id:o,distance:a.haversine(e,n),data:t[o]},r++;return s.sort(function(e,t){return e.distance-t.distance}),s},radians:function(e){return e*Math.PI/180},haversine:function(e,t){var o=6371,n=a.radians(t.lat-e.lat),s=a.radians(t.lng-e.lng),r=Math.sin(n/2)*Math.sin(n/2)+Math.cos(a.radians(e.lat))*Math.cos(a.radians(t.lat))*Math.sin(s/2)*Math.sin(s/2),i=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),l=o*i;return Math.round(l)},parseLatLng:function(e,t,a){var o=this,n=parseFloat(e),s=parseFloat(t);return isNaN(n)||isNaN(s)?(o.set.debug&&console.log("There was a problem with marker â†’",a,e,t),!1):new google.maps.LatLng(n,s)}},o={init:function(t){return this.each(function(){var o=e(this),r=o.data();o.set=e.extend({},n,t,r,s),a.init.apply(o)})},showOnMap:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data()),a.moveToMarker.apply(o,[t.id,t.callback]),o.data(o.set)})},showCoords:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data()),a.moveToCoords.apply(o,[t]),o.data(o.set)})},removeAllMarkers:function(){return this.each(function(){{var t=e(this);t.data()}t.set=e.extend({},t.data()),a.removeAllMarkers.apply(t),t.data(t.set)})},replaceAllMarkers:function(t){return this.each(function(){{var o=e(this);o.data()}o.set=e.extend({},o.data(),t),a.removeAllMarkers.apply(o),a.addMarkers.apply(o),t.startPosition&&a.moveToCoords.apply(o,[t.startPosition]),o.data(o.set)})},update:function(t){return this.each(function(){var o=e(this);o.set=e.extend({},o.data(),t),a.update.apply(o),o.data(o.set)})},destroy:function(t){return this.each(function(){var a=e(this);a.set=e.extend({},a.data(),t,s)})}},n={debug:!1,mapsURL:"//maps.google.com/maps/api/js",urlParams:{},defaultCountry:!1,mapData:"map-data.json",mapOptions:{},markers:[],markerCluster:{},multipleMarker:!1,singleMarker:!1,personMarker:!1,zoomedIn:14,startPosition:!1,strokeColor:"#000000",useMarkerClusterer:!0},s={center:void 0,current:{infoWindow:void 0,position:void 0,nearestStore:void 0,crowFlies:void 0}};e.fn.reppam=function(t){return o[t]?o[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.reppam"):o.init.apply(this,arguments)}}(jQuery,window);