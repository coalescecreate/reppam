/**
 * ys-reppam - Reppam a mapping function used in conjuction with google maps API
 * @version v0.3.0
 * @link http://youngskilled.com
 * @author richard@youngskilled.com Young/Skilled
 * @license MIT
 */
!function(t,e){e.reppamCallback=function(){t(e).trigger("scriptLoaded.reppam")};var o={init:function(){var a=this,n=a.set.urlParams,s=a.set.mapsURL+"?callback=window.reppamCallback";if("undefined"==typeof google){for(var i in n)s+="&"+i+"="+n[i];t.ajax({url:s,dataType:"script",error:function(t){a.set.debug&&console.log("Google maps has failed to load, message: "+t)}})}else t(e).trigger("scriptLoaded.reppam");t(e).on("scriptLoaded.reppam",function(){o.getData.apply(a)})},getData:function(){var e=this;"object"==typeof e.set.mapData?o.renderMap.apply(e):t.ajax({url:e.set.mapData,type:"GET",dataType:"JSON",success:function(t){e.set.mapData=t,e.data("mapData",t),o.renderMap.apply(e)},error:function(t){e.set.debug&&console.log("Map data has failed to load, message: ",t)}})},renderMap:function(){var t,e,a,n,s=this;s.set.startPosition!==!1?(s.set.mapOptions.center=new google.maps.LatLng(s.set.startPosition.lat,s.set.startPosition.lng),s.set.mapOptions.zoom=s.set.startPosition.zoom):s.set.mapData.countries?(t=s.set.mapData.countries[s.set.mapData.currentLocation[0]],s.set.defaultCountry!==!1&&(o.withinBounds(t.sw,t.ne,s.set.mapData.locations)||(t=s.set.mapData.countries[s.set.defaultCountry])),e=new google.maps.LatLng(t.sw.lat,t.sw.lng),a=new google.maps.LatLng(t.ne.lat,t.ne.lng),n=new google.maps.LatLngBounds(e,a)):(s.set.mapOptions.center=new google.maps.LatLng(0,0),s.set.mapOptions.zoom=2),s.set.map=new google.maps.Map(s[0],s.set.mapOptions),s.set.mapData.countries&&s.set.startPosition===!1&&s.set.map.fitBounds(n),s.data("map",s.set.map),google.maps.event.addListener(s.set.map,"tilesloaded",function(){o.logPosition.apply(s)}),o.enableEvents.apply(s),o.addMarkers.apply(s)},enableEvents:function(){var a=this;t("#locate-me").on("click",function(e){e.preventDefault();var n=t(this);n.addClass("loading"),o.getLocation(function(t){o.addMe.apply(a,[t]),n.removeClass("loading").addClass("loaded")})}),t("#nearest").on("click",function(e){e.preventDefault();var n,s,i,r=t(this),l=[];r.addClass("loading"),o.getLocation(function(t){var e;o.addMe.apply(a,[t]),a.set.current.crowFlies&&a.set.current.crowFlies.setMap(null),r.removeClass("loading").addClass("loaded"),l=o.findNearest(t,a.set.mapData.locations),n=new google.maps.LatLng(t.lat,t.lng),s=new google.maps.LatLng(l[0].data.latitude,l[0].data.longitude),e=new google.maps.Polyline({path:[n,s],geodesic:!0,strokeColor:a.set.strokeColor,strokeWeight:3}),google.maps.event.addListener(e,"click",function(){i=new google.maps.LatLngBounds,i.extend(n),i.extend(s),a.set.map.fitBounds(i),o.logPosition.apply(a)}),e.setMap(a.set.map),l[0].distance<100?(i=new google.maps.LatLngBounds,i.extend(n),i.extend(s),a.set.map.fitBounds(i)):(a.set.map.setCenter(s),a.set.map.setZoom(a.set.zoomedIn)),a.set.current.crowFlies=e,o.logPosition.apply(a)})}),t(e).on("resize",function(){a.set.map.setCenter(a.set.center),a.set.map.setZoom(a.set.zoom)})},addMe:function(t){var e,a,n=this,s=n.set.personMarker,i={};n.set.current.position&&n.set.current.position.setMap(null),a=new google.maps.LatLng(t.lat,t.lng),i.position=a,s!==!1&&(i.icon={},s.url&&(i.icon.url=s.url),s.anchor&&(i.icon.anchor=new google.maps.Point(s.anchor[0],s.anchor[1])),s.origin&&(i.icon.origin=new google.maps.Point(s.origin[0],s.origin[1])),s.size&&(i.icon.size=new google.maps.Size(s.size[0],s.size[1])),s.scaledSize&&(i.icon.scaledSize=new google.maps.Size(s.scaledSize[0],s.scaledSize[1]))),e=new google.maps.Marker(i),e.setMap(n.set.map),n.set.map.setCenter(a),google.maps.event.addListener(e,"click",function(){n.set.map.getZoom()<n.set.zoomedIn&&n.set.map.setZoom(n.set.zoomedIn),n.set.map.panTo(this.getPosition()),o.logPosition.apply(n)}),n.set.current.position=e},addMarkers:function(){var t,e,a,n,s=this,i=s.set.mapData.locations,r=s.set.singleMarker,l=s.set.multipleMarker,c=[],d={},p={};for(var g in i)e=i[g],""!==e.latitude&&""!==e.longitude&&(t=new google.maps.LatLng(e.latitude,e.longitude),d={id:g,content:i[g].address,position:t,title:i[g].name},r!==!1&&(d.icon={},r.url&&(d.icon.url=r.url),r.anchor&&(d.icon.anchor=new google.maps.Point(r.anchor[0],r.anchor[1])),r.origin&&(d.icon.origin=new google.maps.Point(r.origin[0],r.origin[1])),r.size&&(d.icon.size=new google.maps.Size(r.size[0],r.size[1])),r.scaledSize&&(d.icon.scaledSize=new google.maps.Size(r.scaledSize[0],r.scaledSize[1]))),a=new google.maps.Marker(d),google.maps.event.addListener(a,"click",function(){var t=new google.maps.InfoWindow({content:this.content});s.set.current.infoWindow&&s.set.current.infoWindow.close(),s.set.map.getZoom()<s.set.zoomedIn&&this.id===s.set.current.viewed&&s.set.map.setZoom(s.set.zoomedIn),s.set.map.panTo(this.getPosition()),t.open(s.set.map,this),s.set.current.infoWindow=t,s.set.current.viewed=this.id,o.logPosition.apply(s)}),c.push(a));if("undefined"!=typeof MarkerClusterer)n=new MarkerClusterer(s.set.map,c,{maxZoom:s.set.zoomedIn-1}),l!==!1&&(p={},l.url&&(p.url=l.url),l.anchor&&(p.anchorIcon=[l.anchor[1],l.anchor[0]]),l.origin&&(p.backgroundPosition="-"+l.origin[0]+"px -"+l.origin[1]+"px"),l.size&&(p.width=l.size[0]),l.size&&(p.height=l.size[1]),l.anchorText&&(p.anchorText=l.anchorText),l.fontFamily&&(p.fontFamily=l.fontFamily),l.fontStyle&&(p.fontStyle=l.fontStyle),l.fontWeight&&(p.fontWeight=l.fontWeight),l.textColor&&(p.textColor=l.textColor),l.textDecoration&&(p.textDecoration=l.textDecoration),l.textSize&&(p.textSize=l.textSize),n.setStyles([p]));else for(var u=0;u<c.length;u++)c[u].setMap(s.set.map)},logPosition:function(){var t=this;t.set.center=t.set.map.getCenter(),t.set.zoom=t.set.map.getZoom()},moveToMarker:function(t,e){var o,a=this,n=a.set.mapData.locations[t];return e=e||function(){},""===n.latitude||""===n.longitude?(a.set.debug&&console.log("This location has no coordinates."),e({success:!1})):(o=new google.maps.LatLng(n.latitude,n.longitude),a.set.map.setCenter(o),a.set.map.setZoom(a.set.zoomedIn),e({success:!0}))},moveToCoords:function(t){var e,o=this;return t.callback=t.callback||function(){},t.lat&&t.lng&&t.zoom?(e=new google.maps.LatLng(t.lat,t.lng),o.set.map.setCenter(e),o.set.map.setZoom(t.zoom),t.callback({success:!0})):(o.set.debug&&console.log("Coordinates need all the values. Latitude, longitude and zoom lat:"+t.lat+" lng: "+t.lng+" zoom: "+t.zoom),t.callback({success:!1}))},getLocation:function(t){var e;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(o){return e={lat:o.coords.latitude,lng:o.coords.longitude},"function"==typeof t?t(e):void 0},function(){handleNoGeolocation(!0)}):handleNoGeolocation(!1)},withinBounds:function(t,e,o){var a,n,s,i=!1;for(a in o)if(n=!1,s=o[a],s.latitude>t.lat&&s.latitude<e.lat&&(n=!0),n&&s.longitude>t.lng&&s.longitude<e.lng){i=!0;break}return i},findNearest:function(t,e){var a,n,s=[],i=0;for(a in e)n={lat:e[a].latitude,lng:e[a].longitude},s[i]={id:a,distance:o.haversine(t,n),data:e[a]},i++;return s.sort(function(t,e){return t.distance-e.distance}),s},radians:function(t){return t*Math.PI/180},haversine:function(t,e){var a=6371,n=o.radians(e.lat-t.lat),s=o.radians(e.lng-t.lng),i=Math.sin(n/2)*Math.sin(n/2)+Math.cos(o.radians(t.lat))*Math.cos(o.radians(e.lat))*Math.sin(s/2)*Math.sin(s/2),r=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),l=a*r;return Math.round(l)}},a={init:function(e){return this.each(function(){var a=t(this),i=a.data();a.set=t.extend({},n,e,i,s),o.init.apply(a),a.data(a.set)})},showOnMap:function(e){return this.each(function(){{var a=t(this);a.data()}a.set=t.extend({},a.data()),o.moveToMarker.apply(a,[e.id,e.callback]),a.data(a.set)})},showCoords:function(e){return this.each(function(){{var a=t(this);a.data()}a.set=t.extend({},a.data()),o.moveToCoords.apply(a,[e]),a.data(a.set)})},update:function(e){return this.each(function(){var a=t(this);a.set=t.extend({},a.data(),e),o.update.apply(a),a.data(a.set)})},destroy:function(e){return this.each(function(){var o=t(this);o.set=t.extend({},o.data(),e,s)})}},n={debug:!1,mapsURL:"//maps.google.com/maps/api/js",urlParams:{},defaultCountry:!1,mapData:"map-data.json",mapOptions:{},multipleMarker:!1,singleMarker:!1,personMarker:!1,zoomedIn:14,startPosition:!1,strokeColor:"#000000"},s={center:void 0,current:{infoWindow:void 0,position:void 0,nearestStore:void 0,crowFlies:void 0}};t.fn.reppam=function(e){return a[e]?a[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void t.error("Method "+e+" does not exist on jQuery.reppam"):a.init.apply(this,arguments)}}(jQuery,window);